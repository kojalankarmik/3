.PHONY: help install migrate run test lint format clean deploy

help:
	@echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
	@echo "  make install     - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏"
	@echo "  make migrate     - –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏"
	@echo "  make run         - –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ"
	@echo "  make test        - –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã"
	@echo "  make lint        - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥ (flake8)"
	@echo "  make format      - —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ (black)"
	@echo "  make clean       - —É–¥–∞–ª–∏—Ç—å .pyc –∏ __pycache__"
	@echo "  make deploy      - —Å–æ–∑–¥–∞—Ç—å zip –¥–ª—è Deploy-F"

install:
	python -m venv venv
	. venv/bin/activate && pip install -r requirements.txt

migrate:
	alembic upgrade head

run:
	python app/main.py

test:
	pytest tests/ -v --tb=short

lint:
	flake8 app/ tests/ --max-line-length=120

format:
	black app/ tests/ --line-length=120

clean:
	find . -type d -name __pycache__ -exec rm -rf {} +
	find . -type f -name "*.pyc" -delete
	find . -type d -name ".pytest_cache" -exec rm -rf {} +

deploy:
	@echo "–°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ –¥–ª—è Deploy-F..."
	mkdir -p deploy-package
	cp -r app/ deploy-package/
	cp requirements.txt deploy-package/
	cp .env.example deploy-package/.env
	cp alembic.ini deploy-package/
	cp -r app/db/migrations deploy-package/
	cd deploy-package && zip -r ../apartments-rental.zip . -x "*.pyc" "__pycache__/*" ".git/*" && cd ..
	@echo "‚úÖ –ê—Ä—Ö–∏–≤ —Å–æ–∑–¥–∞–Ω: apartments-rental.zip"
	@echo "üì§ –ó–∞–≥—Ä—É–∑–∏ –Ω–∞ https://deploy-f.com"